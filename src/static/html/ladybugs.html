<!doctype html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
</head>

<style>
  body, html {
    position: relative;
    width: 100%;
    height: 100%;
    margin: 0;
    padding: 0;
    overflow: hidden;
  }
  html {
    box-sizing: border-box;
  }
  *, *:before, *:after {
    box-sizing: inherit;
  }
  body {
    background: #462 radial-gradient(circle at 10% 10%, #fff4, transparent);
  }
  :root {
    --radians: 0;
    --lightRadians: -1.1;
    --animT: 500ms;
    --color: #f04;
    
		--rndMult: 22695477;
		--rndIncr: 12345;
		--rndMod: 99999999;

		--index: 111111;
  }
  .ladybug {
    --rdns: calc(var(--radians) + var(--lightRadians));
    --remX: calc(cos(var(--rdns))*1rem);
    --remY: calc(sin(var(--rdns))*-1rem);
    --percX: calc(cos(var(--rdns))*1%);
    --percY: calc(sin(var(--rdns))*-1%);

		--seed: calc(var(--range) + var(--index));
		--mod: mod(calc(var(--seed) * var(--rndMult) + var(--rndIncr)), var(--rndMod));
		--rand: calc(var(--mod) / var(--rndMod));
		--randpc: calc(var(--rand)*100%);

		--seed0: calc(123 + var(--index));
		--mod0: mod(calc(var(--seed0) * var(--rndMult) + var(--rndIncr)), var(--rndMod));
		--rand0: calc(var(--mod0) / var(--rndMod));
		--randpc0: calc(var(--rand0)*100%);

		--seed1: calc(234 + var(--index));
		--mod1: mod(calc(var(--seed1) * var(--rndMult) + var(--rndIncr)), var(--rndMod));
		--rand1: calc(var(--mod1) / var(--rndMod));
		--randpc1: calc(var(--rand1)*100%);
    
    /*
    --mod0: mod(calc(var(--rndMult) * var(--index) + 123),var(--rndMod));
    --mod1: mod(calc(var(--rndMult) * var(--index) - 321),var(--rndMod));
    --rand0: calc(var(--mod0) / var(--rndMod));
    --rand1: calc(var(--mod1) / var(--rndMod));
    */
    
    position: absolute;
    width: 1.4rem;
    height: 2rem;
    transform: rotate(calc(var(--radians)*1rad));
    transform-origin: 50% 50%;
    transition:
      transform calc(0.7*var(--animT)) ease-out,
      top var(--animT) ease,
      left var(--animT) ease
    ;
    &:before {
      content: '';
      display: block;
      position: absolute;
      left: -10%;
      top: -10%;
      width: 120%;
      height: 120%;
      background:
        linear-gradient( 30deg, transparent 0% 49%, #000 49% 51%, transparent 51% 100%),
        linear-gradient(  0deg, transparent 0% 49%, #000 49% 51%, transparent 51% 100%),
        linear-gradient(-30deg, transparent 0% 49%, #000 49% 51%, transparent 51% 100%)
      ;
    }
		&:after {
			content: '';
			display: block;
			position: absolute;
			width: 100%;
			height: 100%;
			border-radius: 50% 50% 60% 60%;
            background-color: var(--color);
			background-image:
				radial-gradient(ellipse at calc(50% - 20*var(--percX)) calc(50% - 20*var(--percY)), #FFFA 0%, transparent 30%),
				radial-gradient(circle at 80% 5%, #FFF 0 8%, transparent 8%),
				radial-gradient(circle at 20% 5%, #FFF 0 8%, transparent 8%),
				radial-gradient(circle at 50% -10%, #000 0% 35%, transparent 35%),
				radial-gradient(circle at calc(50% + 40%*var(--rand0)) 50%, #000 0 10%, transparent 12%),
				radial-gradient(circle at calc(50% - 40%*var(--rand0)) 50%, #000 0 10%, transparent 12%),
				radial-gradient(circle at calc(50% + 40%*var(--rand1)) 80%, #000 0 7%, transparent 9%),
				radial-gradient(circle at calc(50% - 40%*var(--rand1)) 80%, #000 0 7%, transparent 9%),
				linear-gradient(90deg, transparent 0% 48%, #0008 48% 52%, transparent 52% 100%)
		  ;
			box-shadow:
				calc(0.4*var(--remX)) calc(0.4*var(--remY)) 0.5rem #FFF3 inset,
				calc(-0.4*var(--remX)) calc(-0.4*var(--remY)) 0.4rem #0008 inset,
				calc(0.4*var(--remX)) calc(0.4*var(--remY)) 0.1rem #0005
		  ;
      transition: background-color calc(2.7*var(--animT)) linear;
		}
  }
</style>

<div style="display:none;">
  <div class="ladybug" style="left: 50%;top:50%;scale:10;--radians:0.5;z-index: 1;"></div>
  <input type="range"/>
</div>

<script>
  const {body} = document
  const createElement = document.createElement.bind(document)
  const isMobile = window.matchMedia('(max-device-width: 600px)').matches
  const isLocalhost = window.location.hostname==='localhost'

  if (isMobile&&isLocalhost) {
    const script = document.createElement('script')
    script.src = '//cdn.jsdelivr.net/npm/eruda'
    body.appendChild(script)
    script.onload = function () {
      eruda.init()
      init()
    }
  } else {
    init()
  }
  
  //////////////////

  function init(){
    const w = document.documentElement.clientWidth // todo update onresize
    const h = document.documentElement.clientHeight
    const input = document.querySelector('input')
    const ladybug = document.querySelector('.ladybug')
    const step = 60
    const num = w*h/3E3<<0

    console.log('hatching', num, 'ladybugs') // todo: remove log
    
    input.addEventListener('input', e=>{
      const value = e.currentTarget.value
      ladybug.style.setProperty('--radians', value/50*Math.PI)
    })
    
    const bugs = Array.from(new Array(num)).map((o,i)=>{
      const ladybug = document.createElement('div')
      ladybug.classList.add('ladybug')
      const {style} = ladybug
      Object.assign(style,{
        left: Math.random()*w*0.9+'px',
        top: Math.random()*h*0.9+'px'
      })
      setStyle(style,{
        radians: Math.random()*2*Math.PI,
        index: 100 + i
      })
      ladybug.addEventListener('click',()=>{
        walk(style)
        colorise(style)
      })
      document.body.appendChild(ladybug)
      return ladybug
    })
    
    function walk(style){
      const x = parseFloat(style.left)
      const y = parseFloat(style.top)
      const radians = parseFloat(style.getPropertyValue('--radians')) + 3*(Math.random() - 0.5)
      const nx = x + step*Math.cos(radians - 0.5*Math.PI)
      const ny = y + step*Math.sin(radians - 0.5*Math.PI)
      const left = nx + 'px'
      const top = ny + 'px'
      Object.assign(style, {left,top})
      setStyle(style,{radians})
      setTimeout(()=>{
        walkClosest(style)
        style.transition = 'none'
        requestAnimationFrame(()=>{
          ;(nx>w||nx<0)&&(style.left = (nx + 2*w)%w + 'px')
          ;(ny>h||ny<0)&&(style.top = (ny + 2*h)%h + 'px')
          requestAnimationFrame(()=>style.removeProperty('transition'))
        })
      },400)
    }

    function walkClosest(style){
      const x = toNumber(style.left)
      const y = toNumber(style.top)
      bugs.filter(bug=>{
        const bugStyle = bug.style
        if (style!==bugStyle){
          const bx = toNumber(bugStyle.left)
          const by = toNumber(bugStyle.top)
          const dx = x-bx
          const dy = y-by
          const d = Math.sqrt(dx*dx+dy*dy)
          return Math.abs(d)<32
        }
      }).forEach(close=>{
        walk(close.style)
        colorise(style)
      })
    }

    function colorise(style){
      const color = `hsl(${10+30*(Math.random()-0.5)<<0}, ${100-20*Math.random()}%, ${40+20*(Math.random()-0.5)<<0}%)`
      setStyle(style,{color})
    }

    function toNumber(s){
      return parseFloat(s.replace(/[^\d.]/g,''))
    }

    function setStyle(style,props){
      Object.entries(props).forEach(([key,value])=>{
        style.setProperty('--'+key, value)
      })
    }
  }
</script>
